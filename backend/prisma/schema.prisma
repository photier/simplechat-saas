// Prisma Schema - Simple Chat Bot SaaS
// Multi-Tenant Architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["saas"]
}

// ============================================
// TENANT MANAGEMENT
// ============================================

model Tenant {
  id         String     @id @default(uuid())
  name       String // Company name: "Acme Corp"
  subdomain  String     @unique // Subdomain: "acme" -> acme.simplechat.bot
  apiKey     String     @unique // Authentication key
  widgetType WidgetType @default(NORMAL)

  // Railway deployment info
  railwayServiceId String? // Railway service ID
  deploymentUrl    String? // Full URL: https://acme.simplechat.bot
  deploymentStatus DeploymentStatus @default(PENDING)

  // Widget configuration (JSON)
  config Json // { mainColor, title, introMessage, desktopHeight, etc. }

  // Status
  status TenantStatus @default(ACTIVE)

  // ============================================
  // NEW: SaaS Authentication Fields
  // ============================================

  // Auth
  email        String? @unique
  passwordHash String?
  fullName     String?
  phone        String?
  country      String? // ISO country code (TR, US, etc.)

  // OAuth Integration
  authProvider       String? @default("email") // 'email', 'google'
  googleId           String? @unique
  googleRefreshToken String?
  avatarUrl          String?
  emailVerified      Boolean @default(false)

  // Activity
  lastLogin DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  chatbots       Chatbot[] // NEW: One tenant can have multiple bots
  users          User[] // Keep for backward compatibility
  integration    Integration?
  aiConfig       AIConfig?
  usageStats     UsageStats[]
  telegramTopics TelegramTopic[]
  Widget         Widget[]

  @@index([subdomain])
  @@index([status])
  @@index([email])
  @@schema("saas")
}

model Widget {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  embedCode String @db.Text // Generated embed script

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@schema("saas")
}

// ============================================
// CHATBOT (Multi-Bot Architecture)
// ============================================

model Chatbot {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Bot Info
  name   String // "Sales Bot", "Support Bot"
  type   BotType // BASIC | PREMIUM
  chatId String  @unique // bot_abc123
  apiKey String  @unique // Authentication key for this bot

  // Status
  status BotStatus @default(PENDING_PAYMENT)
  // PENDING_PAYMENT: Created but not paid yet
  // ACTIVE: Paid and working
  // PAUSED: Payment failed or manually paused
  // DELETED: Soft deleted

  // N8N Integration
  n8nWorkflowId   String? @unique
  n8nWorkflowName String?
  webhookUrl      String? // https://n8n.../webhook/bot_{chatId}

  // Configuration
  config Json // Widget settings (mainColor, title, introMessage, etc.)

  // Billing (Iyzico)
  subscriptionId     String? // Iyzico subscription ID
  subscriptionStatus String? // active, past_due, canceled
  trialEndsAt        DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([chatId])
  @@index([status])
  @@schema("saas")
}

// ============================================
// USER & MESSAGES (Per Tenant)
// ============================================

model User {
  id       String @id // W-Guest-xxx or P-Guest-xxx
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  country String?
  city    String?
  premium Boolean @default(false)

  // Timestamps
  lastSeenAt DateTime @default(now())
  createdAt  DateTime @default(now())

  // Relations
  messages    Message[]
  sessions    Session[]
  widgetOpens WidgetOpen[]

  @@index([tenantId])
  @@index([lastSeenAt])
  @@schema("saas")
}

model Message {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  from      String // 'visitor', 'admin', 'bot'
  text      String  @db.Text
  humanMode Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@schema("saas")
}

model Session {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  humanMode Boolean   @default(false)
  startTime DateTime  @default(now())
  endTime   DateTime?

  @@index([userId])
  @@index([startTime])
  @@schema("saas")
}

model WidgetOpen {
  id     Int    @id @default(autoincrement())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  country String?
  city    String?
  host    String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@schema("saas")
}

// ============================================
// N8N WORKFLOW - MERGED INTO CHATBOT MODEL
// ============================================
// N8N workflow info is now stored directly in the Chatbot model
// Each chatbot has its own n8nWorkflowId and webhookUrl

// ============================================
// NEW: INTEGRATIONS (Telegram, etc.)
// ============================================

model Integration {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Telegram Configuration (Premium only)
  telegramMode     String? @default("managed") // 'managed' or 'custom'
  telegramGroupId  String?
  telegramBotToken String? // Only for 'custom' mode
  usesSharedBot    Boolean @default(false)

  // Business Hours (Premium only)
  businessHoursEnabled Boolean  @default(false)
  timezone             String?  @default("Europe/Istanbul")
  businessDays         String[] // ['monday', 'tuesday', ...]
  startTime            String? // "09:00"
  endTime              String? // "18:00"
  outOfHoursMessage    String?

  // Other Integrations (future)
  slackWebhookUrl   String?
  discordWebhookUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("saas")
}

// ============================================
// NEW: TELEGRAM TOPIC MANAGEMENT
// ============================================

model TelegramTopic {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // User Identification
  userId String // W-Guest-xxx or P-Guest-xxx

  // Telegram Topic Info
  topicId   Int // Telegram message_thread_id
  topicName String // "Customer W-Guest-abc123"

  // Metadata
  isArchived    Boolean  @default(false)
  lastMessageAt DateTime @default(now())
  messageCount  Int      @default(0)

  createdAt DateTime @default(now())

  @@unique([tenantId, userId])
  @@index([tenantId, userId])
  @@index([tenantId, isArchived, lastMessageAt])
  @@schema("saas")
}

// ============================================
// NEW: AI CONFIGURATIONS (Premium)
// ============================================

model AIConfig {
  id       String @id @default(uuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // AI Behavior
  aiInstructions String @default("You are a helpful customer support assistant.") @db.Text
  aiModel        String @default("gpt-4o")
  aiTemperature  Float  @default(0.7)
  aiMaxTokens    Int    @default(500)

  // Knowledge Base (RAG)
  documents            Json    @default("[]") // [{ name, url, uploadedAt, vectorized }]
  qdrantCollectionName String? // tenant_{chatId}

  // Website Crawling (future)
  websiteCrawlEnabled Boolean   @default(false)
  lastCrawlAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("saas")
}

// ============================================
// NEW: USAGE STATS (Billing & Limits)
// ============================================

model UsageStats {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  month DateTime // First day of month: 2025-01-01

  // Metrics
  messageCount      Int @default(0)
  aiMessageCount    Int @default(0)
  humanMessageCount Int @default(0)
  userCount         Int @default(0)
  widgetOpensCount  Int @default(0)

  // Cost Tracking (future)
  aiTokensUsed     Int   @default(0)
  estimatedCostUsd Float @default(0.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, month])
  @@index([tenantId, month])
  @@schema("saas")
}

// ============================================
// CHAT HISTORY (N8N Workflows)
// ============================================
// This is the table used by N8N workflows to store all chat messages
// Separated from public.chat_history (Photier's own data)

model ChatHistory {
  id Int @id @default(autoincrement())

  // Bot & Tenant Identification (CRITICAL for isolation)
  chatbotId String @map("chatbot_id") // bot_abc123 (from Chatbot.chatId)
  tenantId  String @map("tenant_id") // UUID (from Tenant.id) - redundant but useful for queries

  // User Identification
  userId String @map("user_id") // W-Guest-xxx or P-Guest-xxx

  // Message Data
  message String @db.Text
  from    String // 'user', 'admin', 'bot', 'agent'

  // Telegram Integration (Premium only)
  topicId Int? @map("topic_id") // Telegram message_thread_id

  // User Info (collected over time)
  userName String? @map("user_name") // User's name (asked on first message)
  country  String? // Detected from IP
  city     String? // Detected from IP

  // Mode Tracking
  humanMode          Boolean   @default(false) @map("human_mode") // Premium: AI vs Live Support tab
  humanModeExpiresAt DateTime? @map("human_mode_expires_at") // Auto-expire human mode after 30 min
  premium            Boolean   @default(false) // DEPRECATED: Use chatbot.type instead

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Indexes for performance (Prisma uses field names, maps to DB columns automatically)
  @@index([chatbotId, userId], map: "chat_history_chatbot_id_user_id_idx")
  @@index([chatbotId, createdAt], map: "chat_history_chatbot_id_created_at_idx")
  @@index([tenantId, createdAt], map: "chat_history_tenant_id_created_at_idx")
  @@index([userId], map: "chat_history_user_id_idx")
  @@map("chat_history") // Table name in database
  @@schema("saas")
}

// ============================================
// ENUMS
// ============================================

enum WidgetType {
  NORMAL
  PREMIUM

  @@schema("saas")
}

enum DeploymentStatus {
  PENDING
  DEPLOYING
  ACTIVE
  FAILED
  SUSPENDED

  @@schema("saas")
}

enum TenantStatus {
  PENDING   // Email not verified yet
  ACTIVE
  SUSPENDED
  DELETED

  @@schema("saas")
}

enum Plan {
  FREE
  BASIC // $9.99/month - Normal widget
  PREMIUM // $19.99/month - Premium widget with Telegram
  STARTER
  PRO
  ENTERPRISE

  @@schema("saas")
}

enum BotType {
  BASIC // $9.99/month - AI-only chat widget
  PREMIUM // $19.99/month - AI + Live Support tabs

  @@schema("saas")
}

enum BotStatus {
  PENDING_PAYMENT // Created but not paid yet
  ACTIVE // Paid and working
  PAUSED // Payment failed or manually paused
  DELETED // Soft deleted

  @@schema("saas")
}
